@using OnePrice.Domain.Enums;
@using OnePrice.UI.Models.CommonDTOs;
@using OnePrice.UI.Models.PostDTOs;
@model FullPostDTO



<div class="container-fluid bg-white">


	<div class="row p-1 m-1">

		<div class="col-lg-4 img-container m-2">
			<a style="cursor:zoom-in; width:100%; height:100%;" href="@Model.ImgPath" target="_blank">
				<img class="img-fluid" src="@Model.ImgPath">
			</a>
		</div>


		<div class="col-lg-4">
			<div class="  p-2 mb-3 mt-3 rounded-3 bg-off-white">
				<small class="text-muted">Published: @Model.Day @Model.Month @Model.Year, @Model.Hour:@Model.Minute</small>
				<h2 class="mb-0">@Model.Title</h2>
				<h3 class="text-success">@Model.Currency.Symbol @Model.Price</h3>
			</div>

			<div class="p-2 rounded-3 bg-off-white user-info">
				<div class="user-profile-picture">
					<img src=@Model.Author.ImgPath class="img-fluid rounded-circle">
				</div>


				<div class="user-details">
					<p class="mb-1"><strong>@Model.Author.Nickname</strong></p>
					<p class="mb-0 text-muted">User since @Model.Author.CreatedAt.ToLongDateString()</p>
				</div>


			</div>
			<div class="bg-off-white rounded-3 m-2">
				<div class="mb-2">
					<button class="btn btn-primary w-100 m-1 p-1">Send Message</button>
				</div>
				<div>
					<button class="btn btn-secondary w-100 m-1 p-1">Show contacs</button>
				</div>
			</div>

		</div>


		<div class="  p-1 m-1 rounded-3 bg-off-white">

			<div class="m-2 p-2 ">
				@foreach (CommonTagDTO tag in Model.Tags)
				{
					<span class="badge bg-secondary rounded-pill p-2 m-1">
						@tag.Name
					</span>
				}
			</div>


			<div class=" m2 p-2">
				<h3 class="m-2 p-2">Description</h3>
				<p class="p-2 m-2 overflow-hidden text-break">
					@Model.Description
				</p>
				<hr>
				<p class="text-muted p-2  m-2"><small>Id: @Model.Id</small></p>
			</div>
		</div>

		<div id="comments" class="bg-white rounded p-2 m-1">

			<div class="mb-3 bg-off-white">
				<h3 class="p-2 m-2">
					Leave a comment
				</h3>
				<textarea class="form-control comment-input m-3" id="commentInput" rows="1" placeholder="Write your comment..."></textarea>
				<div id="validationErrors"></div>
				<button type="submit" id="submitCommentBtn" class="btn btn-primary m-3" onclick="">Submit</button>
			</div>

			<div id="commentsContainer" class="mb-3 bg-off-white">
				@foreach (var comment in Model.Comments)
				{
					await Html.RenderPartialAsync("_CommentPartial", comment);
				}
			</div>

		</div>


	</div>
</div>

@section Scripts {
	<script>
		$(document).ready(function () {
			$("#submitCommentBtn").click(function () {
				var commentText = $("#commentInput").val();
				var commentData = {
					PostId: @Model.Id,
					Content: commentText
				};
				$.ajax({
					url: '@Url.Action("AddComment", "Comment")',
					type: 'POST',
					data: commentData,
					success: function (result) {
						$("#commentsContainer").append(result);
						$("#commentInput").val('');
					},
					//Error is corectly displayed at console, but #validationErrors is empty
					error: function (xhr) {
						console.log(xhr.responseJSON); // Log the entire responseJSON object
						if (xhr.responseJSON && xhr.responseJSON.Errors) {
							// Handle validation errors
							var errorsHtml = xhr.responseJSON.Errors.map(function (error) {
								return '<li>' + error + '</li>';
							}).join('');
							$("#validationErrors").html('<ul>' + errorsHtml + '</ul>');
						} else {
							// Handle other errors or non-JSON responses
							alert('An error occurred while loading comments.');
						}
					}

				}); 
			});
		});
	</script>
}




